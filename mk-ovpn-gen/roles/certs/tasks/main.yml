---
# tasks file for mk-ovpn-gen

#USAGE:
# ./mkvpn.yml -i localhost, -e 'cadays= 1200 country="ES" province="BCN" \ 
#  city="Sant Cugat" org="SabuesoORG" email="ramiro@gnubit.com" ou="SabuesoOU"'

#- debug: 
#   msg: copy EASY-RSA if exists under /usr/share if exists

- name: Ansible check file exists example.
  stat:
    path: /usr/share/easy-rsa/
  register: usr_easyrsa

- synchronize:
    src: /usr/share/easy-rsa
    dest: cert_files
    rsync_opts:    
      - "--exclude=keys"
      #some times, the "keys" dir unthe easy-rsa is not wide readeable
  when: usr_easyrsa.stat.exists

#source vars
# - name: source vars 
#   command: "source ./vars"
#   args:
#     chdir: '{{ playbook_dir }}/cert_files/easy-rsa/'
#   register: source_output

- name: "source var files"
  shell: "source vars && ./clean-all && ./pkitool --initca"
  args:
     executable: /bin/bash
     chdir: '{{ playbook_dir }}/cert_files/easy-rsa/'
  register: source_output
- debug: var=source_output.stdout_lines

#./clean-all
#./pkitool --initca

- lineinfile:
    path: '{{ playbook_dir }}/cert_files/easy-rsa/vars'
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: 'export CA_EXPIRE=.*$', line: 'export CA_EXPIRE={{ cadays }}' }
    - { regexp: 'export KEY_COUNTRY=.*$', line: 'export KEY_COUNTRY="{{ country }}"' }
    - { regexp: 'export KEY_PROVINCE=.*$', line: 'export KEY_PROVINCE="{{ province }}"' }
    - { regexp: 'export KEY_CITY=.*$', line: 'export KEY_CITY="{{ city }}"' }
    - { regexp: 'export KEY_ORG=.*$', line: 'export KEY_ORG="{{ org }}"' }
    - { regexp: 'export KEY_EMAIL=.*$', line: 'export KEY_EMAIL="{{ email }}"' }
    - { regexp: 'export KEY_OU=.*$', line: 'export KEY_OU="{{ ou}}"' }
